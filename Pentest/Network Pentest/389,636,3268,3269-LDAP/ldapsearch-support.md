# TOC

- [TOC](#toc)
- [TLDR](#tldr)
- [Find basedn](#find-basedn)
- [Common Flags](#common-flags)
- [Useful Info](#useful-info)
- [Basic Usage](#basic-usage)
    - [Unauthenticated ldapsearch](#unauthenticated-ldapsearch)
        - [Search Scope (-s) for base namingcontexts](#search-scope--s-for-base-namingcontexts)
            - [Search Base Distinguished Name (basedn) (-b)](#search-base-distinguished-name-basedn--b)
                - ['(objectClass=person)'](#objectclassperson)
                    - [grep sAMAccountName from '(objectClass=person)'](#grep-samaccountname-from-objectclassperson)
                    - [Option 2 togrep sAMAccountName](#samaccountname)
    - [Authenticated base dn search](#ldapsearch--h-ldapip--b-dccascadedclocal--d-rthompsoncascadelocal--w-ry4n5eva--ldapsearch_authtxt)
    - [Authenticated ldapsearch](#ldapsearch--h-ldapip--b-dcsearchdchtb--d-hopesharpsearchhtb--w-isolationiskey)
- [Common Mistakes](#common-mistakes)
    - [domain\user](#domainuser)


## [TL;DR](#tldr-1)
```sh
ldapsearch -xH ldap://$t -s base namingcontexts
ldapsearch -xH ldap://$t -b 'DC=cascade,DC=local' > ldapsearch_basedn.txt
ldapsearch -xH ldap://$t -b 'DC=cascade,DC=local' '(objectClass=person)' | tee ldap-person.txt

ldapsearch -xH ldap://$t -b 'DC=BLACKFIELD,DC=local' -D 'support@BLACKFIELD.local' -w '#00^BlackKnight'

ldapsearch -H ldap://$t -b 'DC=BLACKFIELD,DC=local' -D 'support@blackfield.local' -w '#00^BlackKnight' | tee ldapsearch-support.txt
```

## [Find basedn](#find-basedn-1)
```sh
(Get-ADDomain).distinguishedname
# or
ldapsearch -xH ldap://$t -s base namingcontexts
```

```sh
PS C:\Users\thm> (Get-ADDomain).distinguishedname
DC=lunar,DC=eruca,DC=com
```

## [Common Flags](#common-flags-1)
```sh
-x         Simple authentication
-H URI     LDAP Uniform Resource Identifier(s)
-s scope   one of base, one, sub or children (search scope)

-b basedn  base dn for search

-D binddn  bind DN (username)
-w passwd  bind password (for simple authentication)
-W         prompt for bind password
```

## [Useful Info](#useful-info-1)
```sh
cat ldap-anonymous.txt | g objectClass | sort -u
cat ldap-anonymous.txt | sort | gi pwd | egv 'badPwdCount|pwdLastSet|minPwdAge|maxPwdAge|minPwdLength|pwdHistoryLength|pwdProperties'
cat ldap-anonymous.txt | egi 'pwd|pass' | sort | egv 'badPwdCount|pwdLastSet|minPwdAge|maxPwdAge|minPwdLength|pwdHistoryLength|pwdProperties|badPasswordTime'
```

# Basic Usage

## Unauthenticated ldapsearch

### Search Scope (-s) for base namingcontexts
-x         Simple authentication
-H URI     LDAP Uniform Resource Identifier(s)
-s scope   one of base, one, sub or children (search scope)
```sh
$ ldapsearch -xH ldap://$t -s base namingcontexts
# extended LDIF
#
# LDAPv3
# base <> (default) with scope baseObject
# filter: (objectclass=*)
# requesting: namingcontexts 
#

#
dn:
namingContexts: DC=cascade,DC=local
namingContexts: CN=Configuration,DC=cascade,DC=local
namingContexts: CN=Schema,CN=Configuration,DC=cascade,DC=local
namingContexts: DC=DomainDnsZones,DC=cascade,DC=local
namingContexts: DC=ForestDnsZones,DC=cascade,DC=local

# search result
search: 2
result: 0 Success

# numResponses: 2
# numEntries: 1
```

### Search Base Distinguished Name (basedn) (-b)
output is too much, redirect the output to a file
-b basedn  base dn for search / search basedn
```sh
$ ldapsearch -xH ldap://$t -b 'DC=cascade,DC=local' > ldapsearch_basedn.txt

$ wc -l ldapsearch_basedn.txt 
6363 ldapsearch_basedn.txt
```

#### '(objectClass=person)'
```sh
$ ldapsearch -xH ldap://$t -b 'DC=cascade,DC=local' '(objectClass=person)' > ldapsearch_objectClass-person.txt

$ wc -l ldapsearch_objectClass-person.txt 
715 ldapsearch_objectClass-person.txt
```

#### grep sAMAccountName from '(objectClass=person)'
```sh
$ cat ldapsearch_objectClass-person.txt | grep sAMAccountName | nl
     1  sAMAccountName: CascGuest
     2  sAMAccountName: CASC-DC1$
     3  sAMAccountName: arksvc
     4  sAMAccountName: s.smith
     5  sAMAccountName: r.thompson
     6  sAMAccountName: util
     7  sAMAccountName: j.wakefield
     8  sAMAccountName: s.hickson
     9  sAMAccountName: j.goodhand
    10  sAMAccountName: a.turnbull
    11  sAMAccountName: e.crowe
    12  sAMAccountName: b.hanson
    13  sAMAccountName: d.burman
    14  sAMAccountName: BackupSvc
    15  sAMAccountName: j.allen
    16  sAMAccountName: i.croft
```

#### sAMAccountName
[Use previous way to avoid multiple queries](#grep-samaccountname-from-objectclassperson)
```sh
$ ldapsearch -xH ldap://$t -b 'DC=cascade,DC=local' '(objectClass=person)' | grep sAMAccountName | nl                   
     1  sAMAccountName: CascGuest
     2  sAMAccountName: CASC-DC1$
     3  sAMAccountName: arksvc
     4  sAMAccountName: s.smith
     5  sAMAccountName: r.thompson
     6  sAMAccountName: util
     7  sAMAccountName: j.wakefield
     8  sAMAccountName: s.hickson
     9  sAMAccountName: j.goodhand
    10  sAMAccountName: a.turnbull
    11  sAMAccountName: e.crowe
    12  sAMAccountName: b.hanson
    13  sAMAccountName: d.burman
    14  sAMAccountName: BackupSvc
    15  sAMAccountName: j.allen
    16  sAMAccountName: i.croft

$ ldapsearch -xH ldap://$t -b 'DC=cascade,DC=local' '(objectClass=person)' | grep -i samaccountname > sAMAccountName.txt

$ wc -l sAMAccountName.txt 
16 sAMAccountName.txt
```

## Authenticated ldapsearch

### ldapsearch -H ldap://$t -b 'DC=cascade,DC=local' -D r.thompson@cascade.local -w rY4n5eva > ldapsearch_auth.txt
Domain must be in `user@domain` format; output is too much, redirect the output to a file
-b basedn  base dn for search
-D binddn  bind DN (username)
-w passwd  bind password (for simple authentication)
```sh
$ ldapsearch -H ldap://$t -b 'DC=cascade,DC=local' -D r.thompson@cascade.local -w rY4n5eva > ldapsearch_auth.txt

$ wc -l ldapsearch_auth.txt  
6370 ldapsearch_auth.txt
```

# Common Mistakes

### Without Domain Name
```sh
$ ldapsearch -H ldap://$t -b 'DC=cascade,DC=local' -D r.thompson -w rY4n5eva > ldapsearch_auth.txt 
ldap_bind: Invalid credentials (49)
        additional info: 80090308: LdapErr: DSID-0C090400, comment: AcceptSecurityContext error, data 52e, v1db1
```
Right way: Username be in `user@domain` format

### domain\user
```sh
-D 'search.htb\hope.sharp'
```
Right way: Domain must be in `user@domain` format
[[SOLVED]Having trouble with LDAP -can you help?](https://forum.zentyal.org/index.php?topic=15240.0)

